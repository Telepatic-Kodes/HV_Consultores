# Plan 05-01: Bundle Optimization with Dynamic Imports

## Phase: 5 — Performance Optimization
## Requirements: PERF-01, PERF-02, PERF-03, PERF-04

## Goal
Reduce page bundle sizes below 300KB First Load JS by dynamically importing heavy libraries (jspdf, xlsx, recharts) and lazy-loading dashboard modules.

## Tasks Completed

### Task 1: Dynamic import jspdf/xlsx in reportes.ts
- Converted all 5 export functions to `async` with `Promise<void>` return
- Replaced top-level `import jsPDF from 'jspdf'` with `await import('jspdf')` inside each function
- Replaced top-level `import * as XLSX from 'xlsx'` with `await import('xlsx')` inside each function
- Replaced top-level `import { saveAs } from 'file-saver'` with dynamic import
- Result: `/dashboard/reportes` dropped from **585 kB → 180 kB** (-69%)

### Task 2: Dynamic import jspdf in reportes-ejecutivo.ts
- Changed `import jsPDF from 'jspdf'` to `import type jsPDF from 'jspdf'` (type-only)
- Made `generarInformeEjecutivoPDF` async with dynamic `import('jspdf')` + `import('jspdf-autotable')`
- Switched helper `autoTable(doc, {})` calls to `(doc as any).autoTable({})` (prototype method)
- Result: `/dashboard/reportes/presentacion` dropped from **390 kB → 253 kB** (-35%)

### Task 3: Dynamic import analytics sub-dashboards
- Replaced 7 static imports with `next/dynamic` + `{ ssr: false }` in analytics/page.tsx
- Added `TabSkeleton` loading component for each lazy tab
- Removed "Phase 7 Implementation Status" card (stale dev metadata)
- Result: `/dashboard/analytics` dropped from **279 kB → 103 kB** (-63%)

### Task 4: Extract KPICard from charts barrel
- Created `KPICard.tsx` as standalone file (doesn't use recharts)
- Removed KPICard from `charts.tsx`
- Removed chart exports from barrel `index.ts` (no consumers via barrel anymore)
- Dashboard home page uses `next/dynamic` for 4 chart components
- Result: All dashboard pages dropped from ~300 kB to ~176 kB (-42%)

### Task 5: Verify caching (PERF-01) — already done
- All 5 analytics API routes already have `Cache-Control: private, max-age=300`
- Alert/report routes have `Cache-Control: private, max-age=60`

### Task 6: Verify images (PERF-03) — N/A
- App uses SVGs (icon.svg) and lucide-react icons
- Zero `<img>` tags in the codebase

## Bundle Size Results

| Page | Before | After | Savings |
|------|--------|-------|---------|
| Shared JS | 87.6 kB | 88 kB | — |
| /dashboard | 299 kB | 300 kB | charts now deferred |
| /dashboard/analytics | 279 kB | 103 kB | **-63%** |
| /dashboard/reportes | 585 kB | 180 kB | **-69%** |
| /dashboard/reportes/presentacion | 390 kB | 253 kB | **-35%** |
| /dashboard/bots | 302 kB | 176 kB | **-42%** |
| /dashboard/chat | 302 kB | 176 kB | **-42%** |
| /dashboard/clasificador | 304 kB | 177 kB | **-42%** |
| /dashboard/sii | 324 kB | 198 kB | **-39%** |

## Files Changed
- MOD: `src/lib/reportes.ts` (dynamic imports for jspdf, xlsx, file-saver)
- MOD: `src/lib/reportes-ejecutivo.ts` (dynamic imports for jspdf, jspdf-autotable)
- MOD: `src/app/dashboard/analytics/page.tsx` (next/dynamic for 7 tab components)
- MOD: `src/app/dashboard/page.tsx` (next/dynamic for 4 chart components)
- NEW: `src/components/dashboard/KPICard.tsx` (extracted from charts.tsx)
- MOD: `src/components/dashboard/charts.tsx` (removed KPICard)
- MOD: `src/components/dashboard/index.ts` (removed chart barrel exports, added KPICard)

## Verification
- `npx tsc --noEmit` → 0 errors
- `npm run build` → clean pass
