---
phase: 01-convex-migration
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - src/providers/realtime-provider.tsx
  - src/hooks/use-realtime.ts
  - convex/notifications.ts
  - convex/bots.ts
  - src/components/dashboard/realtime-toasts.tsx
autonomous: true

must_haves:
  truths:
    - "Real-time notifications appear when data changes"
    - "Dashboard auto-updates when new documents, jobs, or notifications are created"
    - "No Supabase Realtime subscriptions remain active"
  artifacts:
    - path: "src/providers/realtime-provider.tsx"
      provides: "Convex-based realtime provider"
      pattern: "useQuery.*notifications|useQuery.*bots"
    - path: "src/hooks/use-realtime.ts"
      provides: "Convex reactive query hooks"
      pattern: "useQuery\\(api\\."
  key_links:
    - from: "src/providers/realtime-provider.tsx"
      to: "convex/notifications.ts"
      via: "Convex reactive queries"
      pattern: "useQuery\\(api\\.notifications"
    - from: "src/components/dashboard/*"
      to: "RealtimeProvider"
      via: "Context consumption"
      pattern: "useRealtimeContext"
---

<objective>
Replace Supabase Realtime subscriptions with Convex reactive queries for live dashboard updates.

Purpose: Achieve real-time reactivity using Convex's built-in live query system instead of Supabase WebSocket subscriptions.
Output: Dashboard auto-updates when data changes, powered entirely by Convex reactive queries with zero Supabase Realtime dependencies.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/tomas/Escritorio/HV_Consultores/.planning/PROJECT.md
@/home/tomas/Escritorio/HV_Consultores/.planning/ROADMAP.md
@/home/tomas/Escritorio/HV_Consultores/.planning/STATE.md
@/home/tomas/Escritorio/HV_Consultores/.planning/phases/01-convex-migration/01-03-SUMMARY.md
@/home/tomas/Escritorio/HV_Consultores/src/providers/realtime-provider.tsx
@/home/tomas/Escritorio/HV_Consultores/src/hooks/use-realtime.ts
</context>

<tasks>

<task type="auto">
  <name>Replace Supabase Realtime hooks with Convex reactive queries</name>
  <files>
    src/hooks/use-realtime.ts
  </files>
  <action>
Rewrite realtime hooks to use Convex reactive queries instead of Supabase subscriptions.

**Current pattern (Supabase Realtime):**
```typescript
const channel = supabase.channel('notifications')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notificaciones' }, (payload) => {
    // Handle new notification
  })
  .subscribe()
```

**New pattern (Convex reactive):**
```typescript
// Convex queries automatically re-run when data changes - no manual subscription needed
const notifications = useQuery(api.notifications.listNotifications, { user_id, leida: false })
// Component re-renders automatically when new notification is inserted
```

**Rewrite these hooks:**

**useNotificacionesRealtime():**
- Remove Supabase channel subscription
- Return `useQuery(api.notifications.listNotifications, { user_id, leida: false })`
- Convex re-runs query when notifications table changes

**useBotJobsRealtime():**
- Remove Supabase channel for sii_jobs
- Return `useQuery(api.bots.getActiveJobs, {})`
- Auto-updates when job status changes

**useDocumentosRealtime():**
- Remove Supabase subscription
- Return `useQuery(api.documents.listDocuments, { user_id, status: 'pendiente', limit: 100 })`

**useF29Realtime():**
- Remove Supabase subscription
- Return `useQuery(api.f29.listSubmissions, { user_id, limit: 50 })`

**Key insight:** Convex queries are inherently reactive. No need for manual subscription management - just use useQuery() and components auto-update.

Remove all Supabase channel creation, subscription logic, and cleanup code. Simplify to pure useQuery() calls.
  </action>
  <verify>
Hooks use Convex reactive queries:
- `cat src/hooks/use-realtime.ts | grep "supabase.channel"` returns empty (no Supabase subscriptions)
- `cat src/hooks/use-realtime.ts | grep "useQuery"` shows 4+ Convex query hooks
- `cat src/hooks/use-realtime.ts | wc -l` is significantly shorter (no subscription boilerplate)
- `npm run build` completes without errors
  </verify>
  <done>
Realtime hooks use Convex reactive queries. No Supabase subscription code remains.
  </done>
</task>

<task type="auto">
  <name>Update RealtimeProvider to use Convex queries</name>
  <files>
    src/providers/realtime-provider.tsx
  </files>
  <action>
Simplify RealtimeProvider to leverage Convex's automatic reactivity instead of manual state management.

**OLD approach (Supabase):**
- Create channels, listen for postgres_changes events
- Manually update state arrays (notificaciones, eventosRecientes)
- Track connection status via channel state

**NEW approach (Convex):**
- Use Convex queries directly - they auto-update when data changes
- Remove manual state management for data (keep only UI state like isConnected)
- Simplify to pure query consumption

**Changes:**
```typescript
// Remove: useState for notificaciones, eventosRecientes
// Remove: All Supabase channel setup and cleanup
// Remove: Manual event handlers and state updates

// Add: Convex queries
const notifications = useQuery(api.notifications.listNotifications, { user_id, leida: false })
const activeJobs = useQuery(api.bots.getActiveJobs, {})

// Provide via context:
<RealtimeContext.Provider value={{
  userId,
  isConnected: true, // Convex is always connected if client initialized
  notificaciones: notifications || [],
  botsEnEjecucion: activeJobs?.length || 0,
  clearNotificacion: (id) => { /* call mutation */ },
  // ...
}}>
```

**Benefits:**
- 100+ lines of subscription code eliminated
- No manual state synchronization
- Automatic updates via Convex reactivity
- Simpler, more maintainable code

Keep existing context interface to avoid breaking consuming components.
  </action>
  <verify>
RealtimeProvider is simplified and functional:
- `cat src/providers/realtime-provider.tsx | grep "supabase.channel"` returns empty
- `cat src/providers/realtime-provider.tsx | grep useQuery` shows Convex queries
- `cat src/providers/realtime-provider.tsx | wc -l` shows significant line reduction
- `npm run dev` starts without errors
- Dashboard loads and RealtimeContext provides expected values
  </verify>
  <done>
RealtimeProvider uses Convex reactive queries for notifications and bot jobs. Manual subscription code removed.
  </done>
</task>

<task type="auto">
  <name>Test real-time updates with Convex dashboard</name>
  <files>
    src/components/dashboard/realtime-toasts.tsx
  </files>
  <action>
Update realtime toast notifications component to work with Convex reactive queries.

**realtime-toasts.tsx:**
- Component uses `useRealtimeContext()` to get notifications
- When notifications array changes, show toast via Sonner
- Use useEffect to detect new notifications and trigger toast
- Remove any Supabase-specific event handling

**Pattern:**
```typescript
const { notificaciones } = useRealtimeContext()

useEffect(() => {
  // When new notification appears in array, show toast
  const latest = notificaciones[0]
  if (latest) {
    toast[latest.tipo](latest.mensaje, { description: latest.titulo })
  }
}, [notificaciones])
```

**Testing real-time updates:**
To verify Convex reactivity works, manually insert data in Convex dashboard:
1. Open Convex dashboard -> Data -> notifications table
2. Click "Insert Document"
3. Add notification: `{ tipo: "success", titulo: "Test", mensaje: "Real-time works!", user_id: "demo-user" }`
4. Dashboard should auto-update and show toast immediately (no refresh needed)

Document this testing procedure in SUMMARY for verification.
  </action>
  <verify>
Real-time toasts work with Convex:
- `cat src/components/dashboard/realtime-toasts.tsx | grep useRealtimeContext` shows context usage
- `npm run dev` starts successfully
- Dashboard loads without console errors
- Test: Insert notification in Convex dashboard -> toast appears in UI instantly
  </verify>
  <done>
Real-time toast notifications work via Convex reactive queries. Dashboard auto-updates when data changes in Convex.
  </done>
</task>

</tasks>

<verification>
Confirm real-time functionality works with Convex:
1. `grep -r "supabase.channel\|postgres_changes" src/providers/ src/hooks/ | wc -l` returns 0 (no Supabase Realtime)
2. `grep -r "useQuery.*api\\.notifications\|api\\.bots" src/providers/ src/hooks/ | wc -l` shows multiple Convex queries
3. `npm run dev` starts without errors
4. Dashboard loads successfully
5. **Real-time test:** Insert notification in Convex dashboard -> UI updates instantly without page refresh
6. **Real-time test:** Create bot job via Convex dashboard -> active jobs counter updates immediately
</verification>

<success_criteria>
- No Supabase Realtime channel subscriptions remain in code
- RealtimeProvider uses Convex reactive queries exclusively
- Dashboard auto-updates when notifications or jobs change
- Real-time toasts appear when new notifications inserted
- Code is 100+ lines shorter (subscription boilerplate removed)
</success_criteria>

<output>
After completion, create `.planning/phases/01-convex-migration/01-04-SUMMARY.md`
</output>
