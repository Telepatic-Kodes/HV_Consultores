---
phase: 01-convex-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - package.json
  - .env.local
  - convex/tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Convex project is initialized and connected to cloud backend"
    - "All data models exist as Convex schema definitions"
    - "Convex dev server runs without errors"
  artifacts:
    - path: "convex/schema.ts"
      provides: "Complete schema definitions for all tables"
      min_lines: 200
      contains: "defineSchema"
    - path: "package.json"
      provides: "Convex dependencies installed"
      contains: "convex"
    - path: ".env.local"
      provides: "Convex environment variables"
      contains: "CONVEX_DEPLOYMENT"
  key_links:
    - from: "convex/schema.ts"
      to: "Convex cloud"
      via: "npx convex dev"
      pattern: "defineSchema|defineTable"
---

<objective>
Initialize Convex backend and define complete data schema mirroring existing Supabase tables.

Purpose: Establish the foundation for migrating from Supabase to Convex by setting up the new backend infrastructure and data models.
Output: Working Convex project with complete schema, connected to Convex cloud, ready for queries/mutations.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/tomas/Escritorio/HV_Consultores/.planning/PROJECT.md
@/home/tomas/Escritorio/HV_Consultores/.planning/ROADMAP.md
@/home/tomas/Escritorio/HV_Consultores/.planning/STATE.md
@/home/tomas/Escritorio/HV_Consultores/.planning/REQUIREMENTS.md
@/home/tomas/Escritorio/HV_Consultores/src/types/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Initialize Convex project and install dependencies</name>
  <files>
    package.json
    convex/tsconfig.json
    .env.local
  </files>
  <action>
Install Convex and initialize project:
- Run `npm install convex` to add Convex client and dev tools
- Run `npx convex dev --once` to initialize Convex project (creates convex/ directory, tsconfig.json)
- Follow prompts to create new Convex deployment or link existing
- Add Convex deployment URL to .env.local as `NEXT_PUBLIC_CONVEX_URL` and `CONVEX_DEPLOYMENT`
- Verify convex/tsconfig.json was created with proper configuration

Do NOT remove Supabase dependencies yet - that happens in final cleanup plan.
  </action>
  <verify>
Check files exist and configuration is valid:
- `ls convex/tsconfig.json` shows file exists
- `cat .env.local | grep CONVEX` shows Convex environment variables
- `cat package.json | grep convex` shows convex dependency
- `npx convex dev --help` runs without errors
  </verify>
  <done>
Convex is installed, project is initialized with deployment URL configured in environment variables.
  </done>
</task>

<task type="auto">
  <name>Define Convex schema for all data models</name>
  <files>
    convex/schema.ts
  </files>
  <action>
Create comprehensive Convex schema matching Supabase database structure from database.types.ts.

Define tables with proper field types and indexes:

**Core tables:**
- `documentos` - Document uploads (id, tipo, archivo_url, status, cuenta_final_id, cuenta_sugerida_id, confianza_ml, clasificado_at, created_at, updated_at, user_id)
- `clientes` - Client records (id, nombre, rut, email, telefono, created_at, updated_at)
- `f29_submissions` - F29 tax form submissions (id, periodo, rut, estado, archivo_url, resultado_validacion, submitted_at, created_at, user_id)
- `f29_validaciones` - F29 validation results (id, submission_id, tipo_validacion, resultado, mensaje, created_at)
- `sii_jobs` - RPA job queue (id, tipo, estado, parametros, resultado, error, started_at, completed_at, created_at, user_id)
- `sii_execution_steps` - Task execution logs (id, job_id, paso, estado, detalles, timestamp)
- `credenciales_portales` - Portal credentials (id, portal, rut, encrypted_data, is_valid, last_validated, created_at, user_id)
- `notificaciones` - Notifications (id, tipo, titulo, mensaje, enlace, leida, created_at, user_id)
- `chat_messages` - Chat history (id, role, content, context, created_at, user_id)
- `documentos_conocimiento` - RAG knowledge base (id, titulo, contenido, embedding, metadata, created_at)
- `bancos_transacciones` - Bank transactions (id, banco, fecha, descripcion, monto, categoria, reconciliado, created_at, user_id)

**Analytics tables:**
- `alertas_reglas` - Alert rules (id, nombre, condicion, activa, created_at, user_id)
- `reportes_cronograma` - Scheduled reports (id, tipo, frecuencia, destinatarios, activo, created_at, user_id)

Use Convex types:
- `v.id("table_name")` for foreign keys
- `v.string()`, `v.number()`, `v.boolean()` for primitives
- `v.optional()` for nullable fields
- `v.union()` for enum-like fields (e.g., status: v.union(v.literal("pendiente"), v.literal("clasificado")))
- Define indexes for common queries (by user_id, by created_at, by status)

Reference: https://docs.convex.dev/database/schemas
  </action>
  <verify>
Schema validates and deploys successfully:
- `npx convex dev` runs without schema validation errors
- `cat convex/schema.ts | grep defineTable` shows all tables defined
- `cat convex/schema.ts | grep "v.index"` shows indexes created
- Convex dashboard shows tables created
  </verify>
  <done>
All data models exist as Convex tables with proper types, indexes, and relationships. Schema deploys successfully to Convex cloud.
  </done>
</task>

<task type="auto">
  <name>Create ConvexProvider setup for Next.js</name>
  <files>
    src/providers/convex-provider.tsx
    src/app/layout.tsx
  </files>
  <action>
Create Convex client provider for Next.js App Router:

**convex-provider.tsx:**
- Import `ConvexProvider` and `ConvexReactClient` from "convex/react"
- Create client: `new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!)`
- Export provider component wrapping children with ConvexProvider
- Mark as 'use client' directive

**Update layout.tsx:**
- Import ConvexProvider from @/providers/convex-provider
- Wrap {children} with ConvexProvider (place after existing Supabase auth setup for now)
- Keep existing RealtimeProvider - it will be migrated in later plan

DO NOT remove Supabase providers yet - dual stack runs temporarily during migration.

Reference: https://docs.convex.dev/quickstart/nextjs
  </action>
  <verify>
Provider is set up correctly:
- `cat src/providers/convex-provider.tsx | grep "use client"` shows client directive
- `cat src/providers/convex-provider.tsx | grep ConvexReactClient` shows client initialization
- `cat src/app/layout.tsx | grep ConvexProvider` shows provider added to layout
- `npm run dev` starts without provider errors
  </verify>
  <done>
ConvexProvider is configured in app layout, Convex client connects to cloud deployment successfully.
  </done>
</task>

</tasks>

<verification>
Run checks to confirm foundation is ready:
1. `npx convex dev` starts without errors and shows "Convex functions ready"
2. Convex dashboard (https://dashboard.convex.dev) shows project with all tables
3. `npm run dev` starts Next.js dev server with Convex provider initialized
4. Browser console shows no Convex connection errors
5. Schema file contains all tables from requirements (documents, clients, F29, bots, banks, chat, analytics)
</verification>

<success_criteria>
- Convex project initialized and connected to cloud deployment
- Schema defines 15+ tables matching Supabase structure
- ConvexProvider integrated into Next.js layout
- Dev server runs with Convex and Supabase coexisting (dual stack)
- No schema validation errors in Convex dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/01-convex-migration/01-01-SUMMARY.md`
</output>
