---
phase: 01-convex-migration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - convex/documents.ts
  - convex/clients.ts
  - convex/f29.ts
  - convex/bots.ts
  - convex/notifications.ts
  - convex/chat.ts
autonomous: true

must_haves:
  truths:
    - "All CRUD operations are available as Convex queries and mutations"
    - "Queries return data in expected format matching Supabase responses"
    - "Mutations accept same parameters as current Supabase operations"
  artifacts:
    - path: "convex/documents.ts"
      provides: "Document queries and mutations"
      exports: ["listDocuments", "getDocument", "createDocument", "updateDocument"]
    - path: "convex/clients.ts"
      provides: "Client CRUD operations"
      exports: ["listClients", "getClient", "createClient", "updateClient"]
    - path: "convex/f29.ts"
      provides: "F29 submission queries"
      exports: ["listSubmissions", "getSubmission", "createSubmission", "updateValidation"]
    - path: "convex/bots.ts"
      provides: "Bot job management"
      exports: ["listJobs", "getJob", "createJob", "updateJobStatus"]
    - path: "convex/notifications.ts"
      provides: "Notification CRUD"
      exports: ["listNotifications", "createNotification", "markAsRead"]
    - path: "convex/chat.ts"
      provides: "Chat message operations"
      exports: ["listMessages", "sendMessage"]
  key_links:
    - from: "convex/*.ts"
      to: "convex/schema.ts"
      via: "import from convex/_generated/dataModel"
      pattern: "query|mutation|Doc<"
---

<objective>
Create all Convex queries and mutations to replace existing Supabase database operations.

Purpose: Build the Convex data layer API that frontend components will consume, matching current Supabase query patterns.
Output: Complete set of type-safe Convex functions for all data operations across documents, clients, F29, bots, notifications, and chat.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/tomas/Escritorio/HV_Consultores/.planning/PROJECT.md
@/home/tomas/Escritorio/HV_Consultores/.planning/ROADMAP.md
@/home/tomas/Escritorio/HV_Consultores/.planning/STATE.md
@/home/tomas/Escritorio/HV_Consultores/.planning/phases/01-convex-migration/01-01-SUMMARY.md
@/home/tomas/Escritorio/HV_Consultores/src/app/dashboard/actions.ts
@/home/tomas/Escritorio/HV_Consultores/src/app/dashboard/documentos/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Create document queries and mutations</name>
  <files>
    convex/documents.ts
  </files>
  <action>
Create Convex queries and mutations for document operations.

**Queries:**
- `listDocuments` - Query accepting filters (status, date range, user_id), returns paginated documents with indexes on status, created_at, user_id
- `getDocument` - Query accepting document ID, returns single document with full details
- `getDocumentsByStatus` - Query for filtering by status enum
- `searchDocuments` - Query with text search on tipo, archivo_url fields
- `getDocumentStats` - Query for dashboard stats (count by status, today's uploads)

**Mutations:**
- `createDocument` - Mutation accepting {tipo, archivo_url, user_id}, creates document with status="pendiente"
- `updateDocument` - Mutation accepting {id, ...fields}, updates document
- `classifyDocument` - Mutation accepting {id, cuenta_final_id, confianza_ml}, sets status="clasificado", clasificado_at
- `deleteDocument` - Mutation accepting id, removes document

Use Convex patterns:
- Import `{ query, mutation }` from "./_generated/server"
- Import `{ v }` from "convex/values" for argument validation
- Use `ctx.db.query("documentos")` for reads
- Use `ctx.db.insert("documentos", {...})` for creates
- Use `ctx.db.patch(id, {...})` for updates
- Add .index() filters for performance
- Return types match Supabase return shapes for easy frontend migration

Reference existing Supabase queries in src/app/dashboard/documentos/actions.ts
  </action>
  <verify>
Functions deploy and execute successfully:
- `npx convex dev` shows no TypeScript errors in documents.ts
- `cat convex/documents.ts | grep "export const"` shows all query/mutation exports
- Convex dashboard Functions tab shows documents.ts functions deployed
- Test query in dashboard: call listDocuments() returns empty array (no data yet)
  </verify>
  <done>
Document queries and mutations exist, deploy successfully, and are callable from Convex dashboard.
  </done>
</task>

<task type="auto">
  <name>Create queries/mutations for clients, F29, bots, notifications</name>
  <files>
    convex/clients.ts
    convex/f29.ts
    convex/bots.ts
    convex/notifications.ts
  </files>
  <action>
Create Convex functions for remaining core entities following same patterns as documents.ts.

**clients.ts:**
- Queries: listClients, getClient, searchClients
- Mutations: createClient, updateClient, deleteClient
- Indexes: by nombre, rut, created_at

**f29.ts:**
- Queries: listSubmissions (filter by periodo, estado, user_id), getSubmission, getSubmissionValidations
- Mutations: createSubmission, updateSubmissionStatus, createValidation
- Indexes: by periodo, estado, user_id, created_at

**bots.ts (SII job management):**
- Queries: listJobs (filter by tipo, estado, user_id), getJob, getJobSteps, getActiveJobs
- Mutations: createJob, updateJobStatus, addExecutionStep, completeJob, failJob
- Indexes: by tipo, estado, user_id, created_at, completed_at

**notifications.ts:**
- Queries: listNotifications (filter by user_id, leida), getUnreadCount
- Mutations: createNotification, markAsRead, markAllAsRead, deleteNotification
- Indexes: by user_id, leida, created_at

Each file should:
- Import query/mutation from _generated/server
- Validate arguments with v.object() schemas
- Use proper indexes for performance
- Return data in shapes matching current Supabase responses

Reference existing Server Actions to understand current query patterns and return shapes.
  </action>
  <verify>
All functions deploy without errors:
- `npx convex dev` completes successfully with no TypeScript errors
- `ls convex/ | grep -E "clients|f29|bots|notifications"` shows all 4 files
- Convex dashboard Functions tab shows 25+ total functions across all files
- Test each file's list query in dashboard returns empty array (schema exists, no data)
  </verify>
  <done>
Queries and mutations for clients, F29, bots, and notifications are implemented, type-safe, and deployed to Convex.
  </done>
</task>

<task type="auto">
  <name>Create chat and bank transaction functions</name>
  <files>
    convex/chat.ts
    convex/banks.ts
  </files>
  <action>
Create remaining Convex functions for chat and bank modules.

**chat.ts:**
- Queries: listMessages (filter by user_id, paginated with limit/cursor), searchMessages (RAG semantic search prep)
- Mutations: sendMessage (creates message with role, content, context), deleteMessage
- Indexes: by user_id, created_at (DESC for latest first)

**banks.ts:**
- Queries: listTransactions (filter by banco, fecha range, categoria, reconciliado), getTransaction, getTransactionStats
- Mutations: createTransaction, updateTransaction, categorizeTransaction, reconcileTransaction, bulkImportTransactions
- Indexes: by banco, fecha, categoria, reconciliado, user_id

Use Convex pagination patterns:
- Accept `paginationOpts` in queries
- Return `{ page: [...], continueCursor, isDone }`
- Use `.paginate(paginationOpts)` on queries

For chat RAG integration (future), structure messages with optional context field to store embeddings reference.
  </action>
  <verify>
Chat and bank functions are operational:
- `npx convex dev` deploys with zero errors
- `cat convex/chat.ts | grep sendMessage` shows mutation exists
- `cat convex/banks.ts | grep bulkImportTransactions` shows bulk import mutation
- Convex dashboard shows 35+ total functions across all modules
- Test sendMessage() in dashboard creates a chat message successfully
  </verify>
  <done>
Chat and bank transaction queries/mutations exist and are ready for frontend integration. All core CRUD operations available in Convex.
  </done>
</task>

</tasks>

<verification>
Verify complete Convex API layer is operational:
1. `npx convex dev` runs with zero TypeScript errors
2. Convex dashboard Functions tab shows 35+ deployed functions
3. Each module (documents, clients, f29, bots, notifications, chat, banks) has list/get/create/update functions
4. Test queries in dashboard return expected empty arrays or success responses
5. All functions use proper argument validation with v.object() schemas
</verification>

<success_criteria>
- 35+ Convex queries and mutations deployed successfully
- All CRUD operations match existing Supabase patterns
- Functions are type-safe with proper argument validation
- Indexes defined for common query patterns
- Return shapes compatible with current frontend expectations
</success_criteria>

<output>
After completion, create `.planning/phases/01-convex-migration/01-02-SUMMARY.md`
</output>
