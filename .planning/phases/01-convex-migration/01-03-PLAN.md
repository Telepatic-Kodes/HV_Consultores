---
phase: 01-convex-migration
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/dashboard/actions.ts
  - src/app/dashboard/documentos/actions.ts
  - src/app/dashboard/f29/actions.ts
  - src/app/dashboard/sii/actions.ts
  - src/app/dashboard/reportes/actions.ts
  - src/components/dashboard/DocumentListView.tsx
  - src/components/dashboard/Sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard pages load data from Convex queries instead of Supabase"
    - "All Server Actions use Convex API instead of createClient()"
    - "Components use useQuery from convex/react instead of Supabase client"
  artifacts:
    - path: "src/app/dashboard/actions.ts"
      provides: "Server Actions calling Convex API"
      pattern: "api.documents|api.clients|api.f29"
    - path: "src/components/dashboard/DocumentListView.tsx"
      provides: "Component using Convex hooks"
      pattern: "useQuery.*documents"
  key_links:
    - from: "src/app/dashboard/actions.ts"
      to: "convex/documents.ts"
      via: "Convex client API calls"
      pattern: "convex.query|convex.mutation"
    - from: "src/components/dashboard/*.tsx"
      to: "convex hooks"
      via: "useQuery/useMutation"
      pattern: "useQuery\\(api\\."
---

<objective>
Migrate all Server Actions and dashboard components from Supabase client to Convex queries/mutations.

Purpose: Replace Supabase data fetching with Convex reactive queries across all dashboard pages and actions.
Output: Dashboard fully powered by Convex backend with zero Supabase query calls remaining in dashboard code.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/tomas/Escritorio/HV_Consultores/.planning/PROJECT.md
@/home/tomas/Escritorio/HV_Consultores/.planning/ROADMAP.md
@/home/tomas/Escritorio/HV_Consultores/.planning/STATE.md
@/home/tomas/Escritorio/HV_Consultores/.planning/phases/01-convex-migration/01-02-SUMMARY.md
@/home/tomas/Escritorio/HV_Consultores/src/app/dashboard/actions.ts
@/home/tomas/Escritorio/HV_Consultores/src/app/dashboard/page.tsx
@/home/tomas/Escritorio/HV_Consultores/src/components/dashboard/DocumentListView.tsx
</context>

<tasks>

<task type="auto">
  <name>Migrate dashboard Server Actions to Convex API</name>
  <files>
    src/app/dashboard/actions.ts
  </files>
  <action>
Replace all Supabase queries in Server Actions with Convex API calls.

**Pattern:**
OLD (Supabase):
```typescript
const supabase = createClient()
const { data, error } = await supabase.from('documentos').select('*')
```

NEW (Convex):
```typescript
import { ConvexHttpClient } from "convex/browser"
import { api } from "@/convex/_generated/api"

const convex = new ConvexHttpClient(process.env.NEXT_PUBLIC_CONVEX_URL!)
const data = await convex.query(api.documents.listDocuments, { /* filters */ })
```

**Migrate these Server Actions:**
- `getDashboardStats()` → call api.documents.getDocumentStats, api.f29.listSubmissions, etc.
- `getModulosStatus()` → call api.bots.getActiveJobs, api.notifications.getUnreadCount
- `getActividadReciente()` → call api.notifications.listNotifications with limit
- `getDocumentosPorDia()` → call api.documents.listDocuments with date grouping
- `getF29PorMes()` → call api.f29.listSubmissions with periodo grouping
- `getBotsActividad()` → call api.bots.listJobs with status filters
- `getKPIs()` → aggregate from multiple Convex queries

**Important:**
- Server Actions remain 'use server' - they call Convex via HTTP client (ConvexHttpClient), not hooks
- Return shapes should match existing return types to minimize component changes
- Handle errors with try/catch, return fallback values
- Keep parameter signatures identical to avoid breaking calling code

Do NOT modify components yet - that's next task.
  </action>
  <verify>
Server Actions call Convex successfully:
- `cat src/app/dashboard/actions.ts | grep "createClient"` returns empty (no Supabase client)
- `cat src/app/dashboard/actions.ts | grep "convex.query"` shows Convex API calls
- `npm run dev` starts without TypeScript errors
- Dashboard page loads (even if components still use Supabase client hooks)
  </verify>
  <done>
All dashboard Server Actions fetch data from Convex instead of Supabase. Functions return expected data shapes.
  </done>
</task>

<task type="auto">
  <name>Migrate client components to Convex hooks</name>
  <files>
    src/components/dashboard/DocumentListView.tsx
    src/components/dashboard/Sidebar.tsx
    src/components/dashboard/NotificationsDropdown.tsx
  </files>
  <action>
Replace Supabase client hooks with Convex reactive hooks in dashboard components.

**Pattern:**
OLD (Supabase):
```typescript
import { createClient } from '@/lib/supabase-browser'
const [data, setData] = useState([])
useEffect(() => {
  const fetchData = async () => {
    const supabase = createClient()
    const { data } = await supabase.from('documentos').select('*')
    setData(data || [])
  }
  fetchData()
}, [])
```

NEW (Convex):
```typescript
import { useQuery } from "convex/react"
import { api } from "@/convex/_generated/api"

const documents = useQuery(api.documents.listDocuments, { /* filters */ })
// documents is undefined during loading, then becomes data array
```

**Migrate these components:**

**DocumentListView.tsx:**
- Replace Supabase fetch with `useQuery(api.documents.listDocuments, { status, limit })`
- Handle loading state: `if (!documents) return <LoadingSkeleton />`
- Handle mutations with `useMutation(api.documents.updateDocument)`

**Sidebar.tsx:**
- Replace stats fetch with `useQuery(api.documents.getDocumentStats, {})`
- Update notification count with `useQuery(api.notifications.getUnreadCount, {})`

**NotificationsDropdown.tsx:**
- Replace notifications fetch with `useQuery(api.notifications.listNotifications, { leida: false, limit: 10 })`
- Use `useMutation(api.notifications.markAsRead)` for marking as read

**Important:**
- Remove useState/useEffect patterns - Convex hooks handle state
- Convex queries auto-refresh when data changes (reactive)
- Loading states: check `if (!data)` instead of separate loading boolean
- Keep existing UI/styling unchanged
  </action>
  <verify>
Components render with Convex data:
- `cat src/components/dashboard/DocumentListView.tsx | grep useQuery` shows Convex hook usage
- `cat src/components/dashboard/Sidebar.tsx | grep "createClient"` returns empty
- `npm run dev` builds without errors
- Dashboard page renders document list (even if empty, no errors)
- Browser console shows no Supabase connection errors from these components
  </verify>
  <done>
Dashboard components use Convex reactive queries. Document list, sidebar stats, and notifications load from Convex.
  </done>
</task>

<task type="auto">
  <name>Migrate feature module actions (documentos, f29, sii)</name>
  <files>
    src/app/dashboard/documentos/actions.ts
    src/app/dashboard/f29/actions.ts
    src/app/dashboard/sii/actions.ts
    src/app/dashboard/reportes/actions.ts
  </files>
  <action>
Replace Supabase calls in feature-specific Server Actions with Convex API.

**documentos/actions.ts:**
- `uploadDocument()` → call api.documents.createDocument
- `classifyDocument()` → call api.documents.classifyDocument
- `deleteDocument()` → call api.documents.deleteDocument
- `bulkClassify()` → loop calling api.documents.classifyDocument

**f29/actions.ts:**
- `getF29Submissions()` → call api.f29.listSubmissions
- `createF29Submission()` → call api.f29.createSubmission
- `getF29Validations()` → call api.f29.getSubmissionValidations
- `updateF29Status()` → call api.f29.updateSubmissionStatus

**sii/actions.ts:**
- `getSIIJobs()` → call api.bots.listJobs
- `createSIIJob()` → call api.bots.createJob
- `getSIIJobSteps()` → call api.bots.getJobSteps

**reportes/actions.ts:**
- `getReportData()` → aggregate from api.documents, api.f29, api.bots queries
- Keep report generation logic, just swap data source

Pattern: Import ConvexHttpClient, create client, call api.* functions. Return shapes match existing to avoid breaking calling code.
  </action>
  <verify>
Feature actions use Convex successfully:
- `grep -r "createClient" src/app/dashboard/*/actions.ts | wc -l` returns 0 (no Supabase client imports)
- `grep -r "convex.query\|convex.mutation" src/app/dashboard/*/actions.ts | wc -l` shows 15+ Convex API calls
- `npm run build` completes without TypeScript errors
- Each module (documentos, f29, sii, reportes) has Convex integration
  </verify>
  <done>
All feature module Server Actions fetch and mutate data via Convex API. Document workflows, F29 submissions, and SII jobs powered by Convex.
  </done>
</task>

</tasks>

<verification>
Confirm dashboard is fully Convex-powered:
1. `grep -r "from '@/lib/supabase" src/app/dashboard/ src/components/dashboard/ | wc -l` returns 0 (no Supabase imports)
2. `grep -r "useQuery\|useMutation" src/components/dashboard/ | wc -l` shows 10+ Convex hook usages
3. `npm run dev` starts successfully
4. Visit http://localhost:3000/dashboard - page loads without errors
5. Browser Network tab shows Convex API requests, no Supabase API requests
6. Dashboard stats, document list, notifications display (even if empty data)
</verification>

<success_criteria>
- All Server Actions in dashboard/ use ConvexHttpClient instead of Supabase client
- All client components use useQuery/useMutation from convex/react
- Dashboard pages load data from Convex queries successfully
- Zero Supabase query calls in dashboard code paths
- No TypeScript errors or runtime errors in dashboard
</success_criteria>

<output>
After completion, create `.planning/phases/01-convex-migration/01-03-SUMMARY.md`
</output>
