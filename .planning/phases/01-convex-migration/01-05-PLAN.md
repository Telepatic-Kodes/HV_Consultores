---
phase: 01-convex-migration
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified:
  - package.json
  - .env.local
  - .env.example
  - src/lib/supabase-server.ts
  - src/lib/supabase-browser.ts
  - src/lib/supabase.ts
  - src/middleware.ts
autonomous: false

must_haves:
  truths:
    - "Package.json contains zero Supabase dependencies"
    - "Environment variables reference only Convex"
    - "Application builds successfully with npm run build"
    - "No Supabase client imports remain in codebase"
  artifacts:
    - path: "package.json"
      provides: "Clean dependency list"
      pattern: "convex"
      not_contains: "@supabase"
    - path: ".env.example"
      provides: "Convex-only environment template"
      contains: "CONVEX_DEPLOYMENT"
      not_contains: "SUPABASE"
  key_links:
    - from: "All source files"
      to: "Convex client"
      via: "No Supabase imports"
      pattern: "^((?!@supabase).)*$"
---

<objective>
Remove all Supabase dependencies, clean up environment variables, and verify clean production build.

Purpose: Complete the migration by eliminating all Supabase code and configuration, ensuring the application runs entirely on Convex.
Output: Clean codebase with zero Supabase dependencies, passing build, and Convex-only configuration.
</objective>

<execution_context>
@/home/tomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/tomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/tomas/Escritorio/HV_Consultores/.planning/PROJECT.md
@/home/tomas/Escritorio/HV_Consultores/.planning/ROADMAP.md
@/home/tomas/Escritorio/HV_Consultores/.planning/STATE.md
@/home/tomas/Escritorio/HV_Consultores/.planning/phases/01-convex-migration/01-04-SUMMARY.md
@/home/tomas/Escritorio/HV_Consultores/package.json
@/home/tomas/Escritorio/HV_Consultores/.env.example
</context>

<tasks>

<task type="auto">
  <name>Remove Supabase client files and middleware</name>
  <files>
    src/lib/supabase-server.ts
    src/lib/supabase-browser.ts
    src/lib/supabase.ts
    src/middleware.ts
  </files>
  <action>
Delete or stub out Supabase client files that are no longer needed.

**Files to remove entirely:**
- `src/lib/supabase-server.ts` - Server-side Supabase client (replaced by ConvexHttpClient)
- `src/lib/supabase-browser.ts` - Browser-side Supabase client (replaced by Convex hooks)
- `src/lib/supabase.ts` - Legacy Supabase singleton (if exists)

**Middleware update:**
If `src/middleware.ts` contains Supabase auth checks, update it:
- Remove Supabase session verification
- Add comment: "// Auth middleware disabled - using demo mode per project requirements"
- Keep middleware file but make it a no-op or remove auth logic
- Per STATE.md decision: "Keep demo mode (internal tool, no real auth needed)"

**Verify no imports remain:**
After deleting files, scan for any remaining imports:
```bash
grep -r "from '@/lib/supabase" src/
grep -r "import.*supabase" src/
```
If any found, they're in files that weren't migrated yet - document in SUMMARY.

Do NOT delete auth pages (login, registro) yet - they may be repurposed for demo UI or removed in Phase 2 cleanup.
  </action>
  <verify>
Supabase client files are removed:
- `ls src/lib/supabase-*.ts 2>/dev/null | wc -l` returns 0 (files deleted)
- `grep -r "from '@/lib/supabase" src/ | wc -l` returns 0 (no imports)
- `cat src/middleware.ts | grep supabase` returns empty (no Supabase references)
- `npm run dev` starts without module not found errors
  </verify>
  <done>
Supabase client files deleted. Middleware no longer references Supabase. No orphaned imports remain.
  </done>
</task>

<task type="auto">
  <name>Uninstall Supabase packages and clean dependencies</name>
  <files>
    package.json
  </files>
  <action>
Remove all Supabase npm packages from dependencies.

**Packages to uninstall:**
```bash
npm uninstall @supabase/supabase-js @supabase/auth-helpers-nextjs @supabase/auth-helpers-react @supabase/ssr
```

This removes:
- `@supabase/supabase-js` - Core Supabase client
- `@supabase/auth-helpers-nextjs` - Next.js auth helpers
- `@supabase/auth-helpers-react` - React auth hooks
- `@supabase/ssr` - Server-side rendering utilities

**After uninstalling:**
- Run `npm install` to update package-lock.json
- Verify package.json dependencies section contains no @supabase/* packages
- Verify node_modules no longer contains @supabase directories

**Keep these dependencies:**
- All Radix UI packages (used for UI components)
- Convex (newly added)
- Next.js, React, TypeScript, Tailwind (core stack)
- All other existing dependencies (OpenAI, jspdf, xlsx, etc.)
  </action>
  <verify>
Supabase packages are completely removed:
- `cat package.json | grep @supabase` returns empty (no dependencies)
- `ls node_modules/@supabase 2>/dev/null | wc -l` returns 0 (packages uninstalled)
- `npm list @supabase/supabase-js` shows error "package not found" (expected)
- `npm run build` starts without errors about missing Supabase modules
  </verify>
  <done>
All Supabase packages uninstalled from package.json and node_modules. Dependency tree clean.
  </done>
</task>

<task type="auto">
  <name>Update environment variables and clean build verification</name>
  <files>
    .env.local
    .env.example
    .env.production.example
  </files>
  <action>
Remove Supabase environment variables and update documentation.

**Update .env.local (local development):**
- Remove: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
- Keep: `NEXT_PUBLIC_CONVEX_URL`, `CONVEX_DEPLOYMENT` (added in plan 01)
- Keep: All other env vars (OPENAI_API_KEY, NUBOX_*, RPA server config, etc.)

**Update .env.example (template for developers):**
- Remove all SUPABASE_* variables
- Add Convex variables with example values:
  ```
  # Convex Backend
  NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
  CONVEX_DEPLOYMENT=prod:your-deployment-name
  ```
- Add comment: "# Supabase removed - now using Convex for all data storage and real-time"

**Update .env.production.example (if exists):**
- Same changes as .env.example

**Clean build verification:**
After env changes, run full production build test:
```bash
npm run build
```

This verifies:
- No missing Supabase env var errors
- All Convex API calls work with configured deployment
- TypeScript compilation passes
- Next.js optimizes pages successfully
- No runtime errors during build

If build fails, document errors in SUMMARY for investigation.
  </action>
  <verify>
Environment is Convex-only and build succeeds:
- `cat .env.example | grep SUPABASE` returns empty (no Supabase vars)
- `cat .env.example | grep CONVEX` shows Convex configuration
- `cat .env.local | grep SUPABASE` returns empty (removed from local env)
- `npm run build` completes successfully with exit code 0
- Build output shows "Compiled successfully" with no errors
  </verify>
  <done>
Environment variables updated to Convex-only configuration. Clean production build passes with zero errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Convex migration - Supabase fully removed, application running on Convex backend
  </what-built>
  <how-to-verify>
1. **Start development server:**
   ```bash
   npm run dev
   ```
   Server should start on http://localhost:3000 without errors

2. **Visit dashboard:** http://localhost:3000/dashboard
   - Dashboard should load successfully
   - Stats cards should display (may show zeros if no data)
   - No console errors about Supabase or missing modules

3. **Test real-time updates:**
   - Open Convex dashboard: https://dashboard.convex.dev
   - Navigate to Data -> notifications table
   - Insert test notification: `{ tipo: "success", titulo: "Migration Complete", mensaje: "Convex works!", user_id: "demo-user" }`
   - Notification toast should appear in dashboard immediately (no page refresh)

4. **Test data operations:**
   - In Convex dashboard, insert test document in documents table
   - Dashboard document list should auto-update showing new document
   - Delete document - list should update reactively

5. **Verify clean build:**
   ```bash
   npm run build
   ```
   Should complete with "Compiled successfully" and no Supabase-related errors

6. **Verify environment:**
   ```bash
   cat .env.local | grep SUPABASE
   # Should return empty (no Supabase env vars)

   cat package.json | grep @supabase
   # Should return empty (no Supabase dependencies)
   ```

**Expected results:**
- ✓ Dashboard loads and displays correctly
- ✓ Real-time updates work via Convex
- ✓ No Supabase dependencies or env vars remain
- ✓ Production build completes successfully
- ✓ No console errors or warnings

**If any issues found:**
- Describe what's not working (broken page, console errors, build failures)
- Include error messages and screenshots
- Type "issues: [description]" to document problems
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass, or describe any issues found
  </resume-signal>
</task>

</tasks>

<verification>
Final migration verification checklist:
1. `grep -r "@supabase" src/ package.json .env* | wc -l` returns 0 (no Supabase references)
2. `cat package.json | jq '.dependencies | keys | .[]' | grep convex` shows convex package
3. `npm run build` exits with code 0 (successful build)
4. `ls convex/ | wc -l` shows 10+ files (schema + all query/mutation modules)
5. Dashboard runs on http://localhost:3000/dashboard with no errors
6. Real-time test: Insert in Convex dashboard -> UI updates instantly
</verification>

<success_criteria>
- Zero Supabase dependencies in package.json
- Zero Supabase environment variables
- Application builds successfully with `npm run build`
- Dashboard loads and functions correctly
- Real-time updates work via Convex reactive queries
- No Supabase client imports remain anywhere in src/
</success_criteria>

<output>
After completion, create `.planning/phases/01-convex-migration/01-05-SUMMARY.md`
</output>
